<!--=================================================================-->
<!-- Plik:          index.html                                       -->
<!-- Wersja:        5.35 FINAL                                             -->       
<!-- Data:          11.11.2025                                       -->
<!-- Autor:         PPSerwis AIRSOFT & more                          -->
<!-- Copyright (c) 2025 PPSerwis AIRSOFT & more                      -->
<!-- Licencja:      MIT License (zobacz plik LICENSE w repozytorium) -->
<!-- Opis Zmian:                                                     -->
<!--  - [CHORE] Dodano informacje o prawach autorskich i licencji.   -->
<!-- ================================================================-->
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drybox Control</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="header-title">Drybox Control</h1>
            <a href="/settings" class="settings-link" title="Ustawienia">‚öôÔ∏è</a>
        </header>
        <main class="dashboard-layout">
            <div class="main-column">
                <div class="card">
                    <h2>Wykres na ≈ªywo</h2>
                    <canvas id="liveChart"></canvas>
                </div>
            </div>
            <div class="sidebar-column">
                <div class="card">
                    <h2>Status i Kontrola</h2>
                    <div class="status-grid">
                        <div class="data-point"><strong>Temperatura:</strong> <span id="temp">--.-</span> &deg;C</div>
                        <div class="data-point"><strong>Cel Temp:</strong> <span id="target-temp">--</span> &deg;C</div>
                        <div class="data-point"><strong>Wilgotno≈õƒá:</strong> <span id="hum">--.-</span> %</div>
                        <div class="data-point"><strong>Cel Wilg:</strong> <span id="target-hum">--</span> %</div>
                    </div>
                    <div class="status-icons">
                        <div class="icon" id="icon-heater-main" title="Grza≈Çka G≈Ç√≥wna (23W)">üî•</div>
                        <div class="icon" id="icon-heater-aux1" title="Grza≈Çka Boczna 1 (23W)">üî•</div>
                        <div class="icon" id="icon-heater-aux2" title="Grza≈Çka Boczna 2 (23W)">üî•</div>
                        <div class="icon" id="icon-fan-chamber" title="Wentylator Komory">üå™Ô∏è</div>
                        <div class="icon" id="icon-fan-vent" title="Wentylacja">üí®</div>
                    </div>
                    <div id="heating-phase-status" class="phase-status"></div>
                    <div class="controls">
                        <select id="profile-select">
                            <option value="0">Profil: PLA</option>
                            <option value="1">Profil: PETG</option>
                            <option value="2">Profil: ABS</option>
                            <option value="3">Profil: W≈Çasny</option>
                        </select>
                        <select id="mode-select">
                            <option value="0">Tryb: Czasowy</option>
                            <option value="1">Tryb: Wilgotno≈õƒá</option>
                            <option value="2">Tryb: CiƒÖg≈Çy</option>
                        </select>
                        <div id="time-input-wrapper" class="time-input-wrapper">
                            <label for="drying-time-min">Czas (min):</label>
                            <input type="number" id="drying-time-min" name="drying-time-min" value="360" min="10" step="10">
                        </div>
                        <button id="start-btn">Start</button>
                        <button id="stop-btn">Stop</button>
                    </div>
                </div>
                <div class="card details-card">
                    <h2>Widok Szczeg√≥≈Çowy</h2>
                    <div class="details-grid">
                        <div class="sensor-layout-container">
                            <h3>Temperatury DS18B20</h3>
                            <div class="chamber-view">
                                <div class="sensor-label sl-k2" title="Ty≈Ç Lewy">K2: <span id="ds2">--.-</span></div>
                                <div class="sensor-label sl-k3" title="Ty≈Ç Prawy">K3: <span id="ds0">--.-</span></div>
                                <div class="sensor-label sl-psu" title="Zasilacz">PSU: <span id="ds3">--.-</span></div>
                                <div class="sensor-label sl-k1" title="Prz√≥d Lewy">K1: <span id="ds1">--.-</span></div>
                                <div class="sensor-label sl-k4" title="Prz√≥d Prawy">K4: <span id="ds4">--.-</span></div>
                            </div>
                        </div>
                        <div class="spool-status">
                            <h3>Status Rolek</h3>
                            <div id="spool-grid" class="spool-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        let chart;
        const SPOOL_TYPES = ["Pusty", "PLA", "PETG", "ABS", "ASA", "TPU", "Inny"];
        const SPOOL_COLORS = [
            { name: 'Brak', hex: 'transparent' }, { name: 'Bia≈Çy', hex: '#FFFFFF' },
            { name: 'Czarny', hex: '#000000' }, { name: 'Szary', hex: '#808080' },
            { name: 'Czerwony', hex: '#FF0000' }, { name: 'Zielony', hex: '#008000' },
            { name: 'Niebieski', hex: '#0000FF' }, { name: '≈ª√≥≈Çty', hex: '#FFFF00' },
            { name: 'Pomara≈Ñczowy', hex: '#FFA500' }, { name: 'Fioletowy', hex: '#800080' },
            { name: 'Naturalny', hex: '#F1E9D2' }, { name: 'Srebrny', hex: '#C0C0C0' },
            { name: 'Z≈Çoty', hex: '#FFD700' }, { name: 'Multikolor', hex: 'conic-gradient(red, yellow, lime, aqua, blue, magenta, red)' }
        ];

        function initChart() {
            const ctx = document.getElementById('liveChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [
                    { label: 'Temperatura', yAxisID: 'yTemp', borderColor: 'rgb(255, 99, 132)', tension: 0.1, data: [] },
                    { label: 'Wilgotno≈õƒá', yAxisID: 'yTemp', borderColor: 'rgb(54, 162, 235)', tension: 0.1, data: [] },
                    { label: 'Moc (0-3)', yAxisID: 'yPower', borderColor: 'rgb(255, 206, 86)', tension: 0.1, data: [], steppped: true }
                ]},
                options: {
                    scales: {
                        x: { type: 'time', time: { unit: 'minute' }, title: { display: true, text: 'Czas' } },
                        yTemp: { type: 'linear', position: 'left', min: 0, max: 80, title: { display: true, text: 'Temp (¬∞C) / Wilg (%)' } },
                        yPower: { type: 'linear', position: 'right', min: 0, max: 3, ticks: { stepSize: 1 }, title: { display: true, text: 'Poziom Mocy (0-3)' }, grid: { drawOnChartArea: false } }
                    },
                    animation: { duration: 250 },
                    maintainAspectRatio: false
                }
            });
        }

        function updateUI(data) {
            document.getElementById('header-title').textContent = 'Drybox ' + data.fw_version + ' by PPSerwis AIRSOFT & more';
            
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');

            if (data.mode === "Czuwanie") {
                startBtn.disabled = false;
                stopBtn.disabled = true;
            } else {
                startBtn.disabled = true;
                stopBtn.disabled = false;
            }
            
            document.getElementById('heating-phase-status').textContent = data.heating_phase;
            
            document.getElementById('temp').textContent = data.temp.toFixed(1);
            document.getElementById('hum').textContent = data.hum.toFixed(1);
            document.getElementById('target-temp').textContent = data.target_temp.toFixed(1);
            document.getElementById('target-hum').textContent = data.target_hum.toFixed(0);

            document.getElementById('icon-heater-main').classList.toggle('active', data.icon_heater_main);
            document.getElementById('icon-heater-aux1').classList.toggle('active', data.icon_heater_aux1);
            document.getElementById('icon-heater-aux2').classList.toggle('active', data.icon_heater_aux2);
            document.getElementById('icon-fan-chamber').classList.toggle('active', data.icon_fan_chamber);
            document.getElementById('icon-fan-vent').classList.toggle('active', data.icon_fan_vent);

            document.getElementById('ds0').textContent = data.ds0.toFixed(1);
            document.getElementById('ds1').textContent = data.ds1.toFixed(1);
            document.getElementById('ds2').textContent = data.ds2.toFixed(1);
            document.getElementById('ds3').textContent = data.ds3.toFixed(1);
            document.getElementById('ds4').textContent = data.ds4.toFixed(1);
            
            const spoolGrid = document.getElementById('spool-grid');
            spoolGrid.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const spool = data.spools[i];
                const type = SPOOL_TYPES[spool.type] || 'Brak';
                const color = SPOOL_COLORS[spool.color] || { name: 'Brak', hex: 'transparent'};
                const column = document.createElement('div');
                column.className = 'spool-column';
                
                let colorDotHTML = `<span class="color-dot" style="background: ${color.hex};"></span>`;
                let colorNameHTML = `<span>${color.name}</span>`;
                
                if (type === 'Pusty') { 
                    colorDotHTML = `<span class="color-dot empty"></span>`; 
                    colorNameHTML = '';
                }
                
                column.innerHTML = `<div class="spool-id">${i + 1}</div><div class="spool-type">${type}</div><div class="spool-color">${colorDotHTML}${colorNameHTML}</div>`;
                spoolGrid.appendChild(column);
            }

            const now = Date.now();
            chart.data.datasets[0].data.push({ x: now, y: data.temp });
            chart.data.datasets[1].data.push({ x: now, y: data.hum });
            chart.data.datasets[2].data.push({ x: now, y: data.pid_power });
            
            const twoHoursAgo = now - (2 * 60 * 60 * 1000);
            chart.options.scales.x.min = twoHoursAgo;
            chart.options.scales.x.max = now;
            chart.update();
        }

        async function fetchData() {
            try {
                const response = await fetch('/data');
                if (response.ok) {
                    const data = await response.json();
                    updateUI(data);
                } else { console.error('B≈ÇƒÖd pobierania danych: ', response.status); }
            } catch (error) { console.error('B≈ÇƒÖd sieci: ', error); }
        }

        async function sendCommand(command) {
            try {
                await fetch('/command?' + new URLSearchParams({ cmd: command }));
            } catch (error) { console.error('B≈ÇƒÖd wysy≈Çania komendy: ', error); }
        }

        // ================== POCZƒÑTEK ZMIANY v5.35 ==================
        function handleModeChange() {
            const mode = document.getElementById('mode-select').value;
            const timeWrapper = document.getElementById('time-input-wrapper');
            // Poka≈º pole czasu tylko je≈õli wybrano "Tryb: Czasowy" (indeks 0)
            if (mode === '0') {
                timeWrapper.style.display = 'grid';
            } else {
                timeWrapper.style.display = 'none';
            }
        }

        window.addEventListener('load', () => {
            initChart();
            fetchData(); 
            setInterval(fetchData, 2000);

            // PowiƒÖ≈º funkcjƒô ze zmianƒÖ selecta
            document.getElementById('mode-select').addEventListener('change', handleModeChange);
            // Uruchom raz przy starcie, aby ustawiƒá poprawnƒÖ widoczno≈õƒá
            handleModeChange();

            document.getElementById('start-btn').addEventListener('click', () => {
                const profile = document.getElementById('profile-select').value;
                const mode = document.getElementById('mode-select').value;
                const time = document.getElementById('drying-time-min').value;
                
                let command = `START:${profile}:${mode}`;
                // Do≈ÇƒÖcz czas do polecenia tylko dla trybu czasowego
                if (mode === '0') {
                    command += `:${time}`;
                }
                sendCommand(command);
            });
            document.getElementById('stop-btn').addEventListener('click', () => {
                sendCommand('STOP');
            });
        });
        // =================== KONIEC ZMIANY v5.35 ===================
    </script>
</body>
</html>